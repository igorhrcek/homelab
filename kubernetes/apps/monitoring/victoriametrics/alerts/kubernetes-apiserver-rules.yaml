apiVersion: operator.victoriametrics.com/v1beta1
kind: VMRule
metadata:
  name: kubernetes-apiserver-rules
  namespace: monitoring
spec:
  "groups":
  - "name": |-
      kubernetes-system-apiserver
    "rules":
    - "alert": |-
        KubeClientCertificateExpiration
      "annotations":
        "description": |
          A client certificate used to authenticate to kubernetes apiserver is expiring in less than 7.0 days.
        "runbook_url": |-
          https://github.com/kubernetes-monitoring/kubernetes-mixin/tree/master/runbook.md#alert-name-kubeclientcertificateexpiration
        "summary": |-
          Client certificate is about to expire.
      "expr": |
        histogram_quantile(0.01, sum without (namespace, service, endpoint) (rate(apiserver_client_certificate_expiration_seconds_bucket{job="kube-apiserver"}[5m]))) < 604800
        and
        on(job, cluster, instance) apiserver_client_certificate_expiration_seconds_count{job="kube-apiserver"} > 0
      "for": |-
        5m
      "labels":
        "severity": |-
          warning
    - "alert": |-
        KubeClientCertificateExpiration
      "annotations":
        "description": |
          A client certificate used to authenticate to kubernetes apiserver is expiring in less than 24.0 hours.
        "runbook_url": |-
          https://github.com/kubernetes-monitoring/kubernetes-mixin/tree/master/runbook.md#alert-name-kubeclientcertificateexpiration
        "summary": |-
          Client certificate is about to expire.
      "expr": |
        histogram_quantile(0.01, sum without (namespace, service, endpoint) (rate(apiserver_client_certificate_expiration_seconds_bucket{job="kube-apiserver"}[5m]))) < 86400
        and
        on(job, cluster, instance) apiserver_client_certificate_expiration_seconds_count{job="kube-apiserver"} > 0
      "for": |-
        5m
      "labels":
        "robusta_incidentio_severity": |-
          minor
        "severity": |-
          critical
    - "alert": |-
        KubeAggregatedAPIErrors
      "annotations":
        "description": |
          Kubernetes aggregated API `{{ $labels.instance }}`/`{{ $labels.name }}` has reported `{{ $labels.reason }}` errors.
        "runbook_url": |-
          https://github.com/kubernetes-monitoring/kubernetes-mixin/tree/master/runbook.md#alert-name-kubeaggregatedapierrors
        "summary": |-
          Kubernetes aggregated API has reported errors.
      "expr": |
        sum by(cluster, instance, name, reason)(increase(aggregator_unavailable_apiservice_total{job="kube-apiserver"}[1m])) > 0
      "for": |-
        10m
      "labels":
        "severity": |-
          warning
    - "alert": |-
        KubeAggregatedAPIDown
      "annotations":
        "description": |
          Kubernetes aggregated API `{{ $labels.name }}`/`{{ $labels.namespace }}` has been only `{{ $value | humanize }}`% available over the last 10m.
        "runbook_url": |-
          https://github.com/kubernetes-monitoring/kubernetes-mixin/tree/master/runbook.md#alert-name-kubeaggregatedapidown
        "summary": |-
          Kubernetes aggregated API is down.
      "expr": |
        (1 - max by(name, namespace, cluster)(avg_over_time(aggregator_unavailable_apiservice{job="kube-apiserver"}[10m]))) * 100 < 85
      "for": |-
        5m
      "labels":
        "severity": |-
          warning
    - "alert": |-
        KubeAPITerminatedRequests
      "annotations":
        "description": |
          The kubernetes apiserver has terminated `{{ $value | humanizePercentage }}` of its incoming requests.
        "runbook_url": |-
          https://github.com/kubernetes-monitoring/kubernetes-mixin/tree/master/runbook.md#alert-name-kubeapiterminatedrequests
        "summary": |-
          The kubernetes apiserver has terminated `{{ $value | humanizePercentage }}` of its incoming requests.
      "expr": |
        sum by(cluster) (rate(apiserver_request_terminations_total{job="kube-apiserver"}[10m])) / ( sum by(cluster) (rate(apiserver_request_total{job="kube-apiserver"}[10m])) + sum by(cluster) (rate(apiserver_request_terminations_total{job="kube-apiserver"}[10m])) ) > 0.20
      "for": |-
        5m
      "labels":
        "severity": |-
          warning
    - "alert": |-
        KubeAPIServerErrors
      "annotations":
        "description": |-
          Kubernetes API server on `{{ $labels.cluster }}` cluster is experiencing high error rate.
        "summary": |-
          Kubernetes API server errors
      "expr": |-
        sum(rate(apiserver_request_total{job="apiserver",code=~"(?:5..)"}[2m])) by(cluster,component,job,scope,verb) / sum(rate(apiserver_request_total{job="apiserver"}[2m])) by(cluster,component,job,scope,verb) * 100 > 10
      "for": |-
        5m
      "labels":
        "severity": |-
          warning
